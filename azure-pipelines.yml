variables:
  repo: 'nntin/discord-twitter-bot'

jobs:
- job: 'DockerManifest'
  variables:
  - group: docker-variables
  steps:
  - script: |
    mkdir -p ~/.docker
    echo '{ "experimental": "enabled" }' > ~/.docker/config.json
    displayName: 'Enabling experimental mode in docker'
  - script: |
      echo $(DOCKER_PASSWORD) | docker login --username $(DOCKER_USERNAME) --password-stdin
    displayName: 'Logging into Docker'
  - script: |
      docker pull $(repo):amd64-dev
      docker pull $(repo):arm32v6-dev
      docker pull $(repo):arm64v8-dev
    displayName: 'Pulling Docker images'

  - script: |
      docker manifest create $(repo):dev $(repo):amd64-dev $(repo):arm32v6-dev $(repo):arm64v8-dev
      docker manifest annotate $(repo):dev $(repo):arm32v6-dev --os linux --arch arm
      docker manifest annotate $(repo):dev $(repo):arm64v8-dev --os linux --arch arm64 --variant armv8
      docker manifest push $(repo):dev
    displayName: 'Creating manifest and pushing'

  - script: |
      docker tag $(repo):amd64-dev $(repo):amd64
      docker push $(repo):amd64
      docker tag $(repo):arm32v6-dev $(repo):arm32v6
      docker push $(repo):arm32v6
      docker tag $(repo):arm64v8-dev $(repo):arm64v8
      docker push $(repo):arm64v8
      docker manifest create $(repo):latest $(repo):amd64 $(repo):arm32v6 $(repo):arm64v8
      docker manifest annotate $(repo):latest $(repo):arm32v6 --os linux --arch arm
      docker manifest annotate $(repo):latest $(repo):arm64v8 --os linux --arch arm64 --variant armv8
      docker manifest push $(repo):latest
    condition: |
      and
      (
        in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
        eq(variables['build.sourceBranch'], 'refs/heads/master')
      )
    displayName: 'Creating manifest and pushing'
    env:
      DOCKER_CLI_EXPERIMENTAL: 'enabled'
