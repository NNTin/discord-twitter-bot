variables:
  repo: 'nntin/discord-twitter-bot'

jobs:

- job: 'BasicTest'
  condition: always()
  strategy:
    matrix:
      Python36-Windows-Style:
        PYTHON_VERSION: '3.6'
        IMAGE_NAME: 'vs2017-win2016'
        TOXENV: 'style'
      Python36-Windows:
        PYTHON_VERSION: '3.6'
        IMAGE_NAME: 'vs2017-win2016'
        TOXENV: 'py36'
      Python36-Linux:
        PYTHON_VERSION: '3.6'
        IMAGE_NAME: 'ubuntu-16.04'
        TOXENV: 'py36'
      Python36-MacOSX:
        PYTHON_VERSION: '3.6'
        IMAGE_NAME: 'macos-10.13'
        TOXENV: 'py36'

  pool:
    vmImage: '$(IMAGE_NAME)'

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(PYTHON_VERSION)'

  - script: python -m pip install --upgrade pip && pip install setuptools tox
    displayName: 'Install tox'

  - script: |
      tox -e $(TOXENV)
    displayName: 'unittest'
    env:
      ACCESS_TOKEN: 'X'
      ACCESS_TOKEN_SECRET: 'X'
      CONSUMER_KEY: 'X'
      CONSUMER_SECRET: 'X'
      WEBHOOK_URL: 'X'
      TWITTER_ID: '3065618342'

- job: 'ExtendedTest'
  condition: |
    and
    (
      in(dependencies.BasicTest.result, 'Succeeded', 'SucceededWithIssues', 'Skipped'),
      ne(variables['build.reason'], 'PullRequest')
    )
  dependsOn: 'BasicTest'
  variables:
  - group: dtb-variables
  strategy:
    matrix:
      Python36-Windows:
        PYTHON_VERSION: '3.6'
        IMAGE_NAME: 'vs2017-win2016'
        TOXENV: 'extended'
      Python36-Linux:
        PYTHON_VERSION: '3.6'
        IMAGE_NAME: 'ubuntu-16.04'
        TOXENV: 'extended'
      Python36-MacOSX:
        PYTHON_VERSION: '3.6'
        IMAGE_NAME: 'macos-10.13'
        TOXENV: 'extended'
  pool:
    vmImage: '$(IMAGE_NAME)'

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(PYTHON_VERSION)'

  - script: python -m pip install --upgrade pip && pip install setuptools tox
    displayName: 'Install tox'

  - script: |
      tox -e $(TOXENV)
    displayName: 'unittest'
    env:
      ACCESS_TOKEN: $(CI_ACCESS_TOKEN)
      ACCESS_TOKEN_SECRET: $(CI_ACCESS_TOKEN_SECRET)
      CONSUMER_KEY: $(CI_CONSUMER_KEY)
      CONSUMER_SECRET: $(CI_CONSUMER_SECRET)
      WEBHOOK_URL: $(CI_WEBHOOK_URL)
      TWITTER_ID: '3065618342'

- job: 'DockerBuild'
  condition: |
    and
    (
      in(dependencies.ExtendedTest.result, 'Succeeded', 'SucceededWithIssues'),
      ne(variables['build.reason'], 'PullRequest')
    )
  dependsOn: 'ExtendedTest'
  variables:
  - group: docker-variables
  strategy:
    matrix:
      a53-h3-h5:
        target_arch: 'aarch64'
        docker_arch: 'arm64v8'
      raspberry-pi:
        target_arch: 'arm'
        docker_arch: 'arm32v6'
      most-prominent:
        target_arch: 'x86_64'
        docker_arch: 'amd64'
  pool:
    vmImage: 'Ubuntu-16.04'

  steps:
  - script: docker run --rm --privileged multiarch/qemu-user-static:register
    displayName: 'Registering'

  # https://github.com/multiarch/qemu-user-static/releases
  - script: |
      wget -N https://github.com/multiarch/qemu-user-static/releases/download/v2.9.1-1/x86_64_qemu-$(target_arch)-static.tar.gz
      tar -xvf x86_64_qemu-$(target_arch)-static.tar.gz
      docker pull $(repo) || true
    displayName: 'Fetching...'

  - task: ShellScript@2
    displayName: 'Run build script'
    inputs:
      scriptPath: ./azure/build.sh

  - script: |
      docker build --pull --cache-from $(repo) -f Dockerfile.$(docker_arch) -t $(repo):$(docker_arch)-dev .
    displayName: 'Building Docker image'

  - script: |
      docker login -u $(USERNAME) -p $(PASSWORD)
      docker push $(repo):$(docker_arch)-dev
    condition: |
      and
      (
        in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
        or
        (
          eq(variables['build.sourceBranch'], 'refs/heads/master'),
          eq(variables['build.sourceBranch'], 'refs/heads/dev'),
          eq(variables['build.sourceBranch'], 'refs/heads/azure')
        )
      )
    displayName: 'Publishing Docker image'
    env:
      USERNAME: $(DOCKER_USERNAME)
      PASSWORD: $(DOCKER_PASSWORD)

- job: 'DockerManifest'
  condition: |
    and
    (
      in(dependencies.DockerBuild.result, 'Succeeded', 'SucceededWithIssues'),
      ne(variables['build.reason'], 'PullRequest'),
      or
      (
        eq(variables['build.sourceBranch'], 'refs/heads/dev'),
        eq(variables['build.sourceBranch'], 'refs/heads/azure'),
        eq(variables['build.sourceBranch'], 'refs/heads/master')
      )
    )
  dependsOn: 'DockerBuild'
  variables:
  - group: docker-variables
  steps:
  - script: |
      docker login -u $(USERNAME) -p $(PASSWORD)
    displayName: 'Logging into Docker'
    env:
      USERNAME: $(DOCKER_USERNAME)
      PASSWORD: $(DOCKER_PASSWORD)
  - script: |
      docker pull $(repo):amd64-dev
      docker pull $(repo):arm32v6-dev
      docker pull $(repo):arm64v8-dev
    displayName: 'Pulling Docker images'

  - script: |
      docker manifest create $(repo):dev $(repo):amd64-dev $(repo):arm32v6-dev $(repo):arm64v8-dev
      docker manifest annotate $(repo):dev $(repo):arm32v6-dev --os linux --arch arm
      docker manifest annotate $(repo):dev $(repo):arm64v8-dev --os linux --arch arm64 --variant armv8
      docker manifest push $(repo):dev
    displayName: 'Creating manifest and pushing'

  - script: |
      docker tag $(repo):amd64-dev $(repo):amd64
      docker push $(repo):amd64
      docker tag $(repo):arm32v6-dev $(repo):arm32v6
      docker push $(repo):arm32v6
      docker tag $(repo):arm64v8-dev $(repo):arm64v8
      docker push $(repo):arm64v8
      docker manifest create $(repo):latest $(repo):amd64 $(repo):arm32v6 $(repo):arm64v8
      docker manifest annotate $(repo):latest $(repo):arm32v6 --os linux --arch arm
      docker manifest annotate $(repo):latest $(repo):arm64v8 --os linux --arch arm64 --variant armv8
      docker manifest push $(repo):latest
    condition: |
      and
      (
        in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
        eq(variables['build.sourceBranch'], 'refs/heads/master')
      )
    displayName: 'Creating manifest and pushing'
